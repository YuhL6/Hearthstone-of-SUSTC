# 				南方科技大学炉石传说开发手册（草稿三）

#### 概述

该软件分为三大块，分别为<u>客户端</u>、<u>游戏端</u>、<u>服务器端</u>，其中客户端和游戏端统称<u>前端</u>，五大系统，<u>登录系统</u>、<u>用户系统</u>、<u>好友系统</u>、<u>对战系统</u>、<u>抽卡系统</u>。

用户的信息分为两类：**隐私信息**、**基本信息**、**实时信息**和**用户扩展信息**。<u>基本信息</u>将在登录时进行更新，<u>实时信息</u>将由服务器实时推送，<u>扩展信息</u>服务器默认不推送，除非客户端发出请求。隐私信息包括<u>用户账号</u>、<u>用户密码</u>。基本信息包括<u>1用户昵称</u>（不可重复）、<u>1用户Rank分</u>、<u>用户状态</u>、<u>2用户头像</u>、<u>2用户个性签名</u>、<u>3用户好友昵称</u>、<u>3用户好友头像</u>。实时信息包括<u>用户好友状态</u>、<u>用户好友昵称</u>、<u>用户好友头像</u>。扩展信息包括<u>用户排名信息</u>、<u>用户好友基本信息</u>、<u>用户对战信息</u>、<u>当前Rank榜前十名</u>。

用户状态分为<u>离线</u>、<u>在线</u>，<u>创建房间</u>、<u>游戏中</u>。

当软件打开后先显示<u>登录系统</u>界面，主要功能是核对身份、同步信息。

在登录成功之后进入<u>用户系统</u>界面，用户系统的主要功能是展示<u>用户基本信息</u>、<u>用户扩展信息</u>以及其它系统的入口。

用户在<u>用户系统</u>界面点开好友栏时将打开<u>好友系统</u>，<u>好友系统</u>将展示好友的<u>基本信息</u>，并且具有聊天功能。

###### 安全协议（版本一）

用户在登录时，密码以明文传送。登录成功后，服务器将返还一个随机生成的token值，客户端需要记录此token值，直至本次登录退出，客户端需用token代替密码作为身份标识。

###### 核查信息：

在用户登录后，服务器与客户端将建立长连接，服务器将记录用户的地址信息（IP地址，端口），在之后的访问中，如果用户的地址信息发生变化，服务器将发送核查信息，客户端需返还登录时获得的token值，如符合，服务器将更新用户地址信息。

> 客户端发送某信息A
>
> 服务器发现用户的地址信息发生改变
>
> 服务器发送核查信息：
>
> "300 Socket has changed, please re-verify/r/n"
>
> "/r/n"
>
> 客户端收到此信息后发送token：
>
> "301 user_id token/r/n"
>
> "/r/n"
>
> 服务器返还信息格式见<u>登录确认信息</u>/<u>登录拒绝信息</u>

**Note**: server would not reserve the lost information, so the client should remember the last information and after the verification resend it to the server!!!!

登录

#### 登录系统

<u>登录系统</u>包含有<u>注册</u>、<u>登录</u>、<u>修改密码</u>、<u>忘记密码</u>、<u>同步信息</u>等功能。

<u>登录系统</u>服务器端的端口为14290。

###### 注册

用户注册时需要填写如下信息：<u>邮箱地址</u>（用作账号）、<u>密码</u>（两次确认）、<u>昵称</u>（用户选择），**前端**应当核对<u>邮箱地址是否符合格式</u>、<u>两次密码是否一致</u>。确认无误后前端与服务器建立连接并发送**注册信息**以告知服务器。服务器将检索数据库判断<u>邮箱地址</u>是否已经注册、<u>用户昵称</u>是否已经占用，如有重复则返还**注册拒绝信息**，否则发送验证码到用户邮箱，前端要求用户填写验证码并且发送用户填写的验证码给服务器，如验证码不符合服务器返还<u>注册拒绝信息</u>，符合则返还**注册确认信息**并更新数据库中<u>用户状态</u>、<u>用户连接IP地址</u>。

> **注册信息**格式：
>
> "Method_code time_stamp /r/n"
>
> "User_id User_name User_passport /r/n"
>
> "/r/n"
>
> **注册拒绝信息**格式：
>
> "Method_code time_stamp (reason)/r/n"
>
> "/r/n"
>
> **注册确认信息**格式：
>
> "Method_code time_stamp /r/n"
>
> "/r/n"

**Note**: information are split by space ' ', each information ends with "/r/n"

###### 登录

前端在登录时与服务器建立连接，应发送**登录信息**\*，服务器在接受到信息时，核对账号密码，如不符合则返还**登录拒绝信息**\*，前端应检测发送频率，如过于频繁则应当限制登录时间；如接受信息符合，则返还**登录许可信息**\*，并更新数据库中用户**状态**\*，前端在接收到许可信息后给予登录，而后服务器**核对缺失信息**\*返还对应**用户信息块**\*，前端在接收到信息块之后默认更新信息块。

> **登录信息**格式：
>
> "Method_code time_stamp /r/n"
>
> "User_id User_passport /r/n"
>
> "#information_block Last_modified_time /r/n"		// repeat 9 times to include basic information
>
> "/r/n"
>
> **登录拒绝信息**格式：
>
> "Method_code time_stamp (reason)/r/n"
>
> "/r/n"
>
> **登录许可信息**格式：
>
> 

**Note**: information are split by space ' '

###### 修改密码

修改密码有两种方式：<u>通过现有密码进行修改</u>，<u>通过邮箱验证码进行修改</u>。

<u>通过现有密码进行修改</u>需要用户提供和<u>账号</u>和<u>当前密码</u>并填写<u>修改密码</u>，并且发送信息给服务器，若<u>当前密码</u>正确服务器则返回**修改成功信息**\*，<u>当前密码</u>错误则返回**修改失败信息**\*。

###### 忘记密码

忘记密码同<u>通过邮箱验证码进行修改</u>。

**Method Code**：							**Meaning:**

**200**												   **注册信息**

20



#### 用户系统

port 11579

#### 好友系统



#### 对战系统



#### 协议

**登录信息**应当按照如下顺序发送：<u>账号</u>、<u>密码</u>、<u>MAC地址</u>、<u>缺失信息块</u>。

**登录拒绝信息**包含两种代码，<u>404代表账号不存在</u>，<u>405代表用户密码错误</u>。

**登录许可信息**代码为200，并按顺序带有如下附件：<u>在线好友列表</u>、<u>用户战绩信息</u>、<u>排位信息</u>。其中在线好友列表格式为：<u>账号</u>、<u>好友名</u>、<u>备注</u>（如存在），战绩信息格式为：<u>总场数</u>、<u>胜率</u>，排位信息格式为：<u>Rank分</u>、<u>用户昵称</u>、<u>用户胜率</u>。

**状态**分为三种：<u>离线</u>，<u>在线</u>，<u>游戏中</u>。当某用户状态变化时，服务器将发送信息给其所有在线好友，通知他们更新好友信息。

**用户信息块**包括用户的基本信息：<u>头像</u>、<u>用户名</u>、<u>个人简介</u>、<u>好友信息</u>、<u>战绩信息</u>。

**核对缺失信息**：服务器核对缺失信息逻辑如下：一、根据接收到的缺失信息确定哪些信息块需要返还，二、根据MAC地址是否变化与数据库中记录信息块是否修改判断主机信息是否需要更新。